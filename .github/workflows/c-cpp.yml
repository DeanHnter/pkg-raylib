name: Build raylib

on: workflow_dispatch

jobs:
  build-raylib:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-13, macos-14]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Clone raylib
      run: git clone --recursive https://github.com/raysan5/raylib.git craylib
    
    - name: Install Dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential git cmake libasound2-dev mesa-common-dev libx11-dev libxrandr-dev libxi-dev xorg-dev libgl1-mesa-dev libglu1-mesa-dev libwayland-dev libxkbcommon-dev

    - name: Install Dependencies (macOS)
      if: matrix.os == 'macos-13' || matrix.os == 'macos-14'
      run: |
        brew update
        brew install cmake
    
    - name: Install Dependencies (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        choco install make
        choco install cmake

    - name: Build raylib
      run: |
        mkdir artifacts
        cd craylib
        mkdir build && cd build
        cmake -DPLATFORM=Desktop -DCMAKE_POSITION_INDEPENDENT_CODE=TRUE ..
        cmake --build . --config Release

    - name: Move library (Nix)
      if: matrix.os == 'ubuntu-latest' || matrix.os == 'macos-13' || matrix.os == 'macos-14'
      run: |
        mv craylib/build/raylib/libraylib.a  artifacts/libraylib.a
        
    - name: Move library (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        mv craylib/build/raylib/Release/raylib.lib artifacts/raylib.lib
        
    - name: Archive Production Artifacts
      uses: actions/upload-artifact@v2
      with:
        name: raylib-${{ matrix.os }}
        path: artifacts

  build-onyx:
    permissions:
      contents: write
    needs: build-raylib
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-13, macos-14]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      
    - name: Download build artifacts
      uses: actions/download-artifact@v2
      with:
        path: downloaded-artifacts

    - name: Move raylib
      run: |
        mkdir -p raylib/linux/
        mkdir -p raylib/windows/
        mkdir -p raylib/macos/aarch64
        mv downloaded-artifacts/raylib-ubuntu-latest/libraylib.a raylib/linux/libraylib.a
        mv downloaded-artifacts/raylib-windows-latest/raylib.lib raylib/windows/raylib.lib
        mv downloaded-artifacts/raylib-macos-13/libraylib.a raylib/macos/libraylib.a
        mv downloaded-artifacts/raylib-macos-14/libraylib.a raylib/macos/aarch64/libraylib.a

    - name: Commit Library Files
      if: matrix.os == 'ubuntu-latest'
      run: |
        # Set up Git identity
        git config --global user.name 'onyx-ci'
        git config --global user.email 'onyx-ci@onyxlang.io'
        git add raylib/linux/libraylib.a raylib/windows/raylib.lib raylib/macos/libraylib.a raylib/macos/aarch64/libraylib.a
        git commit -m 'CI: Update raylib binaries'
        
    - name: install wasmer
      run: |
        curl https://get.wasmer.io -sSfL | sh

    - name: onyx build
      run: |
        source /home/runner/.wasmer/wasmer.sh
        echo -e "\n\n\n" | sh <(curl https://get.onyxlang.io -sSfL)  # For simulating 3 Enter presses.
      
    - name: Setup ONYX_PATH and add to PATH
      run: |
        source /home/runner/.wasmer/wasmer.sh
        echo "ONYX_PATH=/home/runner/.onyx" >> $GITHUB_ENV
        echo "/home/runner/.onyx/bin" >> $GITHUB_PATH
        export ONYX_PATH="/home/runner/.onyx"
        export PATH="$ONYX_PATH/bin:$PATH"
        /home/runner/.onyx/bin/onyx run --generate-foreign-info build.onyx
        /home/runner/.onyx/bin/onyx help
      shell: bash

    - name: Build Example
      run: |
        source /home/runner/.wasmer/wasmer.sh
        echo "ONYX_PATH=/home/runner/.onyx" >> $GITHUB_ENV
        echo "/home/runner/.onyx/bin" >> $GITHUB_PATH
        export ONYX_PATH="/home/runner/.onyx"
        export PATH="$ONYX_PATH/bin:$PATH"
        /home/runner/.onyx/bin/onyx build examples/simple_window.onyx
      shell: bash
      
    - name: Push Library Files to main
      if: matrix.os == 'ubuntu-latest'
      run: |
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
